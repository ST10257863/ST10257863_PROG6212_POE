@*
 * Author: Jamie Parker - ST10257863
 * Date: 10 September 2024
 * Project: Contract Monthly Claim System (CMCS)
 *
 * Reference(s):
 * - Microsoft. (2023). Introduction to ASP.NET Core.
 *   Retrieved from https://learn.microsoft.com/en-us/aspnet/core/introduction-to-aspnet-core?view=aspnetcore-8.0
 *   [Accessed: 10 September 2024].
 *@
@{
	ViewData["Title"] = "Claims";
}
<link rel="stylesheet" href="~/css/styles.css" />

<div class="container">
	<div class="background center-content gap-32">
		<!-- Form Section -->
		<form id="claims-form" method="post" action="/Claims/SubmitClaim" enctype="multipart/form-data" class="flex-column center-content gap-32">
			<!-- Input Fields Frame -->
			<div class="flex-column gap-32 center-content">

				<!-- Hours Worked Input -->
				<div class="input-field">
					<label for="hoursWorked" class="text-bold">Hours Worked</label>
					<input type="text" id="hoursWorked" name="hoursWorked" class="input-box" placeholder="Enter hours worked" aria-label="Hours Worked" />
				</div>

				<!-- Overtime Worked Input -->
				<div class="input-field">
					<label for="overtimeWorked" class="text-bold">Overtime Worked</label>
					<input type="text" id="overtimeWorked" name="overtimeWorked" class="input-box" placeholder="Enter overtime worked" aria-label="Overtime Worked" />
				</div>

				<!-- Hourly Rate Input -->
				<div class="input-field">
					<label for="hourlyRateInput" class="text-bold">Hourly Rate (R)</label>
					<input type="text" id="hourlyRateInput" name="hourlyRateInput" class="input-box" placeholder="Enter Hourly Rate" aria-label="Hourly Rate" />
				</div>

				<!-- Document Upload -->
				<div class="input-field">
					<label for="document" class="text-bold">Upload Document</label>
					<input type="file" id="document" name="document" class="input-box" aria-label="Upload Document" />
				</div>
			</div>

			<!-- Calculation Results -->
			<div class="center-content-start">
				<div class="flex-row center-content-start">
					<div class="flex-column gap-32">
						<label for="regularPay" class="text-bold">Regular Pay:</label>
						<label for="overtimePay" class="text-bold">Overtime Pay:</label>
						<label for="totalPay" class="text-bold">Total Pay:</label>
					</div>
					<div class="flex-column gap-32">
						<div id="regularPay" class="text-regular regular-pay-number"> </div>
						<div id="overtimePay" class="text-regular regular-pay-number"> </div>
						<div id="totalPay" class="text-regular regular-pay-number"> </div>
					</div>
				</div>
			</div>

			<!-- Action Buttons -->
			<div class="flex-row gap-32 center-content">
				<button type="button" id="calculate-btn" class="submit-button text-bold">Calculate Pay</button>
				<button type="submit" form="claims-form" class="submit-button text-bold">Submit Claim</button>
			</div>
		</form>

		<!-- Lecturer Details Frame -->
		<div class="center-content-start gap-32 padding-top-16">
			<!--Centre Column-->
			<div class="flex-column flex-grow-1">
				<!--Top Row-->
				<div class="flex-row center-content-start">
					<!-- Labels -->
					<div class="flex-column gap-32">
						<label for="lectureId" class="text-bold">Lecture ID:</label>
						<label for="userName" class="text-bold">User Name:</label>
						<label for="fullName" class="text-bold">Full Name:</label>
						<label for="hourlyRate" class="text-bold">Hourly Rate:</label>
						<label for="department" class="text-bold">Department:</label>
						<label for="campus" class="text-bold">Campus:</label>
					</div>

					<!-- Content -->
					<div class="flex-column gap-32">
						<div id="lectureId" class="text-regular">N/A</div>
						<div id="userName" class="text-regular">N/A</div>
						<div id="fullName" class="text-regular">N/A</div>
						<div id="hourlyRate" class="text-regular">N/A</div>
						<div id="department" class="text-regular">N/A</div>
						<div id="campus" class="text-regular">N/A</div>
					</div>
				</div>
				<!--Bottom Row-->
				<div class="flex-row center-content-start">
					<div class="input-box-textarea">
						<textarea id="userNotes" name="userNotes" class="input-box" placeholder="Enter any additional notes." aria-label="Additional Notes" /></textarea>
					</div>
				</div>
			</div>
		</div>

		<!-- Claim History -->
		<div class="content-container center-content-start gap-16">
			<p class="text-bold">Previous Claims</p>
			<div class="table-container">
				<table class="table table-bordered table-hover">
					<thead class="thead-light">
						<tr>
							<th>ID</th>
							<th>Date & Time</th>
							<th>Status</th>
						</tr>
					</thead>
					<tbody id="table-body">
						<!-- Rows will be inserted here by JavaScript -->
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	$(document).ready(function () {
		// Fetch User ID from session and load lecturer details
		$.ajax({
			url: '/Claims/GetLecturerDetails',
			method: 'GET',
			cache: false, // Prevent caching
			success: function (data) {
				if (data) {
					loadLecturerDetails(data);
				} else {
					console.error('User ID not found in session');
				}
			},
			error: function (err) {
				console.error('Error fetching User ID:', err);
			}
		});

		function loadLecturerDetails(data) {
			if (data) {
				$('#lectureId').text(data.lecturerId || 'N/A');
				$('#userName').text(data.userName || 'N/A');
				$('#fullName').text((data.firstName || 'N/A') + ' ' + (data.lastName || 'N/A'));
				$('#hourlyRate').text('R' + (data.hourlyRate || 0) + '/hr');
				$('#department').text(data.department || 'N/A');
				$('#campus').text(data.campus || 'N/A');
			} else {
				$('#lectureId').text('N/A');
				$('#userName').text('N/A');
				$('#fullName').text('N/A');
				$('#hourlyRate').text('N/A');
				$('#department').text('N/A');
				$('#campus').text('N/A');
			}
		}

		populateTable();

		function populateTable() {
			$.ajax({
				url: '/Claims/LoadLecturerClaims',
				method: 'GET',
				cache: false, // Prevent caching
				success: function (data) {
					if (data && Array.isArray(data) && data.length > 0) {
						data.sort((a, b) => a.claimId - b.claimId);

						const tableBody = $('#table-body');
						tableBody.empty();

						data.forEach(claim => {
							const row = document.createElement('tr');
							row.setAttribute('data-id', claim.claimId);

							row.innerHTML = `<td>${claim.claimId}</td><td>${new Date(claim.submissionDate).toLocaleString()}</td><td>${claim.status}</td>`;
							tableBody.append(row);
						});
					} else {
						console.error('No claims data found');
					}
				},
				error: function (err) {
					console.error('Error fetching claims:', err);
				}
			});
		}

		// Trigger AJAX call to calculate pay
		function calculatePay() {
			var hoursWorked = parseFloat($('#hoursWorked').val());
			var overtimeWorked = $('#overtimeWorked').val(); // Get raw value first

			// Check if inputs are valid and handle missing overtimeWorked
			if (isNaN(hoursWorked)) {
				console.error('Invalid input for hours worked.');
				return;
			}

			if (overtimeWorked === "" || overtimeWorked === null) {
				overtimeWorked = 0; // Default to 0 if empty
			} else {
				overtimeWorked = parseFloat(overtimeWorked);
				if (isNaN(overtimeWorked)) {
					console.error('Invalid input for overtime worked.');
					return;
				}
			}

			$.ajax({
				url: `/Claims/CalculatePay/${hoursWorked}/${overtimeWorked}`, // Pass data via URL
				method: 'POST', // Use POST method as defined in the backend
				success: function (data) {
					if (data.error) {
						console.error('Error calculating pay:', data.error);
						return;
					}

					// Display the calculated pay
					$('#regularPay').text('R' + data.regularPay.toFixed(2));
					$('#overtimePay').text('R' + data.overtimePay.toFixed(2));
					$('#totalPay').text('R' + data.totalPay.toFixed(2));
				},
				error: function (err) {
					console.error('Error calculating pay:', err);
				}
			});
		}

		// Bind the calculate button to the function
		$('#calculate-btn').on('click', function () {
			calculatePay();
		});

	});
</script>

